name: Lotto Generator

on:
  schedule:
    # Wtorek, czwartek, sobota o 18:00 UTC (20:00 CET w zimie, 19:00 CET w lecie)
    - cron: '0 18 * * 2,4,6'
  
  # MoÅ¼liwoÅ›Ä‡ rÄ™cznego uruchomienia
  workflow_dispatch:

jobs:
  generate-lotto:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
    
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'
    
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install requests
    
    - name: Generate lotto numbers
      id: generate
      run: |
        # Uruchamiamy generator i zapisujemy wynik
        python3 lotto_generator.py > lotto_output.txt
        
        # WyciÄ…gamy liczby z wyniku (linia z liczbami po nagÅ‚Ã³wku)
        NUMBERS=$(grep -A3 "TWOJE SZCZÄ˜ÅšLIWE LICZBY LOTTO:" lotto_output.txt | grep -E "^\s+[0-9]" | xargs)
        echo "numbers=$NUMBERS" >> $GITHUB_OUTPUT
        
        # WyciÄ…gamy strategiÄ™
        STRATEGY=$(grep "ğŸ“Š Strategia:" lotto_output.txt | sed 's/.*ğŸ“Š Strategia: //')
        echo "strategy=$STRATEGY" >> $GITHUB_OUTPUT
        
        # WyciÄ…gamy sumÄ™
        SUM=$(grep "â• Suma:" lotto_output.txt | sed 's/.*â• Suma: //' | sed 's/ .*//')
        echo "sum=$SUM" >> $GITHUB_OUTPUT
        
        # WyciÄ…gamy ocenÄ™ eksperta
        RATING=$(grep "â­ Ocena eksperta:" lotto_output.txt | sed 's/.*â­ Ocena eksperta: //')
        echo "rating=$RATING" >> $GITHUB_OUTPUT
        
        # WyciÄ…gamy sekwencje
        SEQUENCES=$(grep "ğŸ”— Sekwencje:" lotto_output.txt | sed 's/.*ğŸ”— Sekwencje: //')
        echo "sequences=$SEQUENCES" >> $GITHUB_OUTPUT
        
        # Zapisujemy peÅ‚ny output dla debugowania
        echo "full_output<<EOF" >> $GITHUB_OUTPUT
        cat lotto_output.txt >> $GITHUB_OUTPUT
        echo "EOF" >> $GITHUB_OUTPUT
        
        # WyÅ›wietlamy wyniki w logu
        cat lotto_output.txt
    
    - name: Send Pushover notification
      env:
        PUSHOVER_TOKEN: ${{ secrets.PUSHOVER_TOKEN }}
        PUSHOVER_USER: ${{ secrets.PUSHOVER_USER }}
      run: |
        # Przygotowujemy dane do wysÅ‚ania
        NUMBERS="${{ steps.generate.outputs.numbers }}"
        STRATEGY="${{ steps.generate.outputs.strategy }}"
        SUM="${{ steps.generate.outputs.sum }}"
        RATING="${{ steps.generate.outputs.rating }}"
        SEQUENCES="${{ steps.generate.outputs.sequences }}"
        DATE=$(date '+%Y-%m-%d %H:%M')
        
        # WiadomoÅ›Ä‡ z rekomendacjami eksperta
        MESSAGE="ğŸ° INTELIGENTNY GENERATOR LOTTO

        ğŸ¯ Liczby: $NUMBERS

        ğŸ§  REKOMENDACJE EKSPERTA:
        ğŸ“Š Strategia: $STRATEGY
        â• Suma: $SUM (optymalna: 120-180)
        ğŸ”— Sekwencje: $SEQUENCES
        â­ Ocena: $RATING

        ğŸ“… Wygenerowano: $DATE
        ğŸ”¬ Oparte na analizie 7,223 losowaÅ„ (1957-2025)
        ğŸ€ Powodzenia w losowaniu!

        ğŸ¤– Automatycznie wygenerowane przez GitHub Actions"

        # WysyÅ‚amy przez Pushover API
        curl -s \
          --form-string "token=$PUSHOVER_TOKEN" \
          --form-string "user=$PUSHOVER_USER" \
          --form-string "title=ğŸ² Inteligentne liczby lotto!" \
          --form-string "message=$MESSAGE" \
          --form-string "priority=0" \
          --form-string "sound=cashregister" \
          https://api.pushover.net/1/messages.json
    
    - name: Upload lotto output as artifact
      uses: actions/upload-artifact@v4.3.1
      with:
        name: lotto-output-${{ github.run_number }}
        path: lotto_output.txt
        retention-days: 30
