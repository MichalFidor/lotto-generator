name: Lotto Generator

on:
  schedule:
    # Wtorek, czwartek, sobota o 18:00 UTC (20:00 CET w zimie, 19:00 CET w lecie)
    - cron: '0 18 * * 2,4,6'
  
  # Mo≈ºliwo≈õƒá rƒôcznego uruchomienia
  workflow_dispatch:

jobs:
  generate-lotto:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
    
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'
    
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install requests
    
    - name: Generate lotto numbers
      id: generate
      run: |
        # Uruchamiamy generator i zapisujemy wynik
        python3 lotto_generator.py > lotto_output.txt
        
        # WyciƒÖgamy liczby z wyniku (linia z liczbami po nag≈Ç√≥wku)
        NUMBERS=$(grep -A3 "TWOJE SZCZƒò≈öLIWE LICZBY LOTTO:" lotto_output.txt | grep -E "^\s+[0-9]" | xargs)
        echo "numbers=$NUMBERS" >> $GITHUB_OUTPUT
        
        # Zapisujemy pe≈Çny output dla debugowania
        echo "full_output<<EOF" >> $GITHUB_OUTPUT
        cat lotto_output.txt >> $GITHUB_OUTPUT
        echo "EOF" >> $GITHUB_OUTPUT
        
        # Wy≈õwietlamy wyniki w logu
        cat lotto_output.txt
    
    - name: Send Pushover notification
      env:
        PUSHOVER_TOKEN: ${{ secrets.PUSHOVER_TOKEN }}
        PUSHOVER_USER: ${{ secrets.PUSHOVER_USER }}
      run: |
        # Przygotowujemy dane do wys≈Çania
        NUMBERS="${{ steps.generate.outputs.numbers }}"
        DATE=$(date '+%Y-%m-%d %H:%M')
        
        # Wiadomo≈õƒá z emojis i formatowaniem
        MESSAGE=$(cat << 'EOF'
        üé∞ LOTTO GENERATOR
        
        üéØ Twoje szczƒô≈õliwe liczby: ${NUMBERS}
        
        üìÖ Wygenerowano: ${DATE}
        üçÄ Powodzenia w losowaniu!
        
        ü§ñ Automatycznie wygenerowane przez GitHub Actions
        EOF
        )

        # Wysy≈Çamy przez Pushover API
        curl -s \
          --form-string "token=$PUSHOVER_TOKEN" \
          --form-string "user=$PUSHOVER_USER" \
          --form-string "title=üé≤ Nowe liczby lotto!" \
          --form-string "message=$MESSAGE" \
          --form-string "priority=0" \
          --form-string "sound=cashregister" \
          https://api.pushover.net/1/messages.json
    
    - name: Upload lotto output as artifact
      uses: actions/upload-artifact@v4.3.1
      with:
        name: lotto-output-${{ github.run_number }}
        path: lotto_output.txt
        retention-days: 30
